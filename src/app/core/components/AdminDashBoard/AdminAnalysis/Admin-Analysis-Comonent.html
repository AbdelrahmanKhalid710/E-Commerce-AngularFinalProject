<!-- analytics.component.html -->
<div class="analytics-container">
  @if (!isLoading) {

    <!-- Header -->
    <div class="header">
      <h1 class="title">Analytics Dashboard</h1>
      <button class="refresh-btn" (click)="refreshData()" [disabled]="isLoading">
        <i class="fas fa-sync-alt"></i>
        Refresh Data
      </button>
    </div>

    <!-- Key Metrics Cards -->
    <div class="metrics-grid">

      <!-- Revenue Card -->
      <div class="metric-card revenue-card">
        <div class="card-header">
          <i class="fas fa-money-bill-wave card-icon"></i>
          <h3>Total Revenue</h3>
        </div>
        <div class="card-content">
          <div class="metric-value">{{ getTotalRevenue() | currency:'EGP' }}</div>
          <div class="metric-description">From {{ getPaidOrders() }} paid orders</div>
        </div>
      </div>

      <!-- Orders Card -->
      <div class="metric-card orders-card">
        <div class="card-header">
          <i class="fas fa-box card-icon"></i>
          <h3>Total Orders</h3>
        </div>
        <div class="card-content">
          <div class="metric-value">{{ getTotalOrders() | number }}</div>
          <div class="metric-description">
            {{ getPaidOrders() }} paid ‚Ä¢ {{ getUnpaidOrders() }} unpaid
          </div>
        </div>
      </div>

      <!-- Users Card -->
      <div class="metric-card users-card">
        <div class="card-header">
          <i class="fas fa-users card-icon"></i>
          <h3>Total Users</h3>
        </div>
        <div class="card-content">
          <div class="metric-value">{{ getTotalUsers() | number }}</div>
          <div class="metric-description">
            {{ getConversionRate() | number:'1.1-1' }}% conversion rate
          </div>
        </div>
      </div>

      <!-- AOV Card -->
      <div class="metric-card aov-card">
        <div class="card-header">
          <i class="fas fa-chart-bar card-icon"></i>
          <h3>Avg Order Value</h3>
        </div>
        <div class="card-content">
          <div class="metric-value">{{ getAverageOrderValue() | currency:'EGP' }}</div>
          <div class="metric-description">Per completed order</div>
        </div>
      </div>

    </div>

    <!-- Charts Section -->
    <div class="charts-section">

      <!-- Payment Methods Chart -->
      <div class="chart-card">
        <h3><i class="fas fa-credit-card"></i> Payment Methods Distribution</h3>
        <div class="chart-container">
          <div class="bar-chart">

            <div class="bar-item">
              <div class="bar-label">Cash</div>
              <div class="bar-track">
                <div class="bar-fill cash-fill" [style.width.%]="getPaymentPercentage('cash')">
                  <span class="bar-value">
                    {{ getCashOrders() }} orders ({{ getCashRevenue() | currency:'EGP' }})
                  </span>
                </div>
              </div>
              <div class="bar-percentage">
                {{ getPaymentPercentage('cash') | number:'1.0-0' }}%
              </div>
            </div>

            <div class="bar-item">
              <div class="bar-label">Card</div>
              <div class="bar-track">
                <div class="bar-fill card-fill" [style.width.%]="getPaymentPercentage('card')">
                  <span class="bar-value">
                    {{ getCardOrders() }} orders ({{ getCardRevenue() | currency:'EGP' }})
                  </span>
                </div>
              </div>
              <div class="bar-percentage">
                {{ getPaymentPercentage('card') | number:'1.0-0' }}%
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Order Status Chart -->
      <div class="chart-card">
        <h3><i class="fas fa-box-open"></i> Order Status Overview</h3>
        <div class="chart-container">
          <div class="status-grid">
            <div class="status-item paid">
              <i class="fas fa-check-circle status-icon"></i>
              <div class="status-info">
                <div class="status-count">{{ getPaidOrders() }}</div>
                <div class="status-label">Paid Orders</div>
              </div>
            </div>
            <div class="status-item unpaid">
              <i class="fas fa-clock status-icon"></i>
              <div class="status-info">
                <div class="status-count">{{ getUnpaidOrders() }}</div>
                <div class="status-label">Unpaid Orders</div>
              </div>
            </div>
            <div class="status-item delivered">
              <i class="fas fa-truck status-icon"></i>
              <div class="status-info">
                <div class="status-count">{{ getDeliveredOrders() }}</div>
                <div class="status-label">Delivered</div>
              </div>
            </div>
            <div class="status-item pending">
              <i class="fas fa-box status-icon"></i>
              <div class="status-info">
                <div class="status-count">{{ getPendingDeliveryOrders() }}</div>
                <div class="status-label">Pending Delivery</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Products Chart -->
      <div class="chart-card full-width">
        <h3><i class="fas fa-trophy"></i> Top Selling Products</h3>
        <div class="chart-container">
          <div class="products-list">
            @for (product of getTopProducts(); track product) {
              <div class="product-item">
                <div class="product-name">{{ product.productName }}</div>
                <div class="product-bar">
                  <div class="product-bar-track">
                    <div class="product-bar-fill" 
                         [style.width.%]="getProductPercentage(product.revenue)">
                    </div>
                  </div>
                  <div class="product-stats">
                    <span class="sales">{{ product.sales }} sales</span>
                    <span class="revenue">{{ product.revenue | currency:'EGP' }}</span>
                    <span class="percentage">
                      {{ getProductPercentage(product.revenue) | number:'1.0-0' }}%
                    </span>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      </div>

    </div>

    <!-- Geographic Analytics Section -->
    <div class="charts-section">
      <div class="chart-card">
        <h3><i class="fas fa-city"></i> Top Cities by Revenue</h3>
        <div class="chart-container">
          <div class="cities-list">
            @for (city of getTopCities(); let i = $index; track city) {
              <div class="city-item">
                <div class="city-rank">#{{ i + 1 }}</div>
                <div class="city-info">
                  <div class="city-name">{{ city.city || 'Unknown' }}</div>
                  <div class="city-stats">
                    <span class="orders">{{ city.orders }} orders</span>
                    <span class="revenue">{{ city.revenue | currency:'EGP' }}</span>
                    <span class="users">{{ city.users }} users</span>
                  </div>
                </div>
                <div class="city-bar">
                  <div class="city-bar-track">
                    <div class="city-bar-fill" 
                         [style.width.%]="(city.revenue / getTotalRevenue()) * 100">
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>

          @if (getCityWithMostOrders()) {
            <div class="city-summary">
              <div class="summary-item">
                <span class="summary-label">üèÜ Top City:</span>
                <span class="summary-value">{{ getCityWithMostOrders()?.city }}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">üì¶ Orders:</span>
                <span class="summary-value">{{ getCityWithMostOrders()?.orders }}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">üí∞ Revenue:</span>
                <span class="summary-value">
                  {{ getCityWithMostOrders()?.revenue | currency:'EGP' }}
                </span>
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Monthly Patterns -->
      <div class="chart-card">
        <h3><i class="fas fa-calendar-alt"></i> Monthly Performance</h3>
        <div class="chart-container">

          @if (getBusiestMonth()) {
            <div class="monthly-highlight busiest-month">
              <div class="highlight-header">
                <i class="fas fa-box highlight-icon"></i>
                <h4>Busiest Order Month</h4>
              </div>
              <div class="highlight-content">
                <div class="highlight-month">{{ getBusiestMonth()?.month }}</div>
                <div class="highlight-stats">
                  <span class="orders">{{ getBusiestMonth()?.orders }} orders</span>
                  <span class="revenue">{{ getBusiestMonth()?.revenue | currency:'EGP' }}</span>
                  <span class="growth" [class]="getGrowthClass(getBusiestMonth()!.growth)">
                    {{ getGrowthIndicator(getBusiestMonth()!.growth) }}
                  </span>
                </div>
              </div>
            </div>
          }

          @if (getPeakRegistrationMonth()) {
            <div class="monthly-highlight registration-month">
              <div class="highlight-header">
                <i class="fas fa-users highlight-icon"></i>
                <h4>Peak Registration Month</h4>
              </div>
              <div class="highlight-content">
                <div class="highlight-month">{{ getPeakRegistrationMonth()?.month }}</div>
                <div class="highlight-stats">
                  <span class="registrations">
                    {{ getPeakRegistrationMonth()?.registrations }} signups
                  </span>
                  <span class="growth" [class]="getGrowthClass(getPeakRegistrationMonth()!.growth)">
                    {{ getGrowthIndicator(getPeakRegistrationMonth()!.growth) }}
                  </span>
                </div>
              </div>
            </div>
          }

        </div>
      </div>
    </div>

    <!-- Time Patterns Section -->
    <div class="charts-section">

      <!-- Peak Hours -->
      <div class="chart-card">
        <h3><i class="fas fa-clock"></i> Peak Ordering Hours</h3>
        <div class="chart-container">
          <div class="hours-list">
            @for (hour of getPeakHours(); track hour) {
              <div class="hour-item">
                <div class="hour-time">{{ hour.hour }}</div>
                <div class="hour-bar">
                  <div class="hour-bar-track">
                    <div class="hour-bar-fill" 
                         [style.width.%]="(hour.orders / getTotalOrders()) * 100">
                    </div>
                  </div>
                </div>
                <div class="hour-orders">{{ hour.orders }} orders</div>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Weekly Pattern -->
      <div class="chart-card">
        <h3><i class="fas fa-calendar-week"></i> Weekly Order Pattern</h3>
        <div class="chart-container">
          <div class="weekly-pattern">
            @for (day of getWeeklyPattern(); track day) {
              <div class="day-item">
                <div class="day-name">{{ day.day }}</div>
                <div class="day-bar">
                  <div class="day-bar-track">
                    <div class="day-bar-fill" 
                         [style.width.%]="(day.orders / getTotalOrders()) * 100">
                    </div>
                  </div>
                </div>
                <div class="day-orders">{{ day.orders }}</div>
              </div>
            }
          </div>
        </div>
      </div>

    </div>

  } @else {
    <div class="loading-container">
      <div class="spinner"></div>
      <p class="loading-text">Loading analytics data...</p>
    </div>
  }
</div>